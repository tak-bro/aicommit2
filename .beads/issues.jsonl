{"id":"aicommit2-1ae","title":"Rename invocation methods","description":"Rename invocation methods in BedrockService for clarity.\n\nCONTEXT: The current method names (invokeFoundationModel, invokeApplicationEndpoint) suggest they're for different model types. Actually, they represent different AUTH methods:\n- invokeFoundationModel uses AWS SDK with IAM auth\n- invokeApplicationEndpoint uses manual HTTPS with Bearer token\n\nGOAL: Rename methods to reflect authentication method, not model type.\n\nFILE: src/services/ai/bedrock.service.ts\n\nCHANGES:\n1. Line 287: Rename 'invokeFoundationModel' to 'invokeWithAwsSdk'\n2. Line 352: Rename 'invokeApplicationEndpoint' to 'invokeWithBearerToken'\n3. Update all call sites to use new names\n\nNO LOGIC CHANGES - just rename the methods and their invocations.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:20.276271-06:00","updated_at":"2025-12-29T20:44:47.262793-06:00","closed_at":"2025-12-29T20:44:47.262796-06:00"}
{"id":"aicommit2-3em","title":"Update service tests","description":"Rewrite tests/specs/bedrock/index.ts for auth-based approach.\n\nCONTEXT: Current tests validate runtimeMode behavior. Need to test auth method detection instead.\n\nGOAL: Test authentication-based invocation.\n\nFILE: tests/specs/bedrock/index.ts\n\nREPLACE ALL TESTS with these scenarios:\n\n1. Test: 'throws error when no authentication configured'\n   Config: no key, no profile, no accessKeyId\n   Expect: Constructor throws 'Authentication required'\n\n2. Test: 'throws error when region missing'\n   Config: has key but no region\n   Expect: Constructor throws 'AWS region is required'\n\n3. Test: 'uses AWS SDK with profile'\n   Config: model, region, profile (no key)\n   Expect: Service created successfully\n   \n4. Test: 'uses AWS SDK with access keys'\n   Config: model, region, accessKeyId, secretAccessKey (no key)\n   Expect: Service created successfully\n\n5. Test: 'uses Bearer token with API key only'\n   Config: model, region, key (no AWS creds)\n   Expect: Service created successfully\n\n6. Test: 'prefers AWS SDK when both auth methods configured'\n   Config: model, region, profile, key (both)\n   Expect: Service created successfully\n   Verify: determineAuthMethod() returns 'aws-sdk'\n\n7. Test: 'works with foundation model ID'\n   Config: model='anthropic.claude-haiku-4-5-20251001-v1:0', region, profile\n   Expect: Service created successfully\n\n8. Test: 'works with cross-region profile'\n   Config: model='us.anthropic.claude-3-5-sonnet-20240620-v1:0', region, profile\n   Expect: Service created successfully\n\n9. Test: 'works with application profile ARN'\n   Config: model='arn:aws:bedrock:us-east-1:123456789012:application-inference-profile/abc123', region, key\n   Expect: Service created successfully\n\nREMOVE all runtimeMode references from tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:24.246161-06:00","updated_at":"2025-12-29T20:44:48.266659-06:00","closed_at":"2025-12-29T20:44:48.266662-06:00"}
{"id":"aicommit2-6fj","title":"Update Bedrock documentation","description":"Rewrite docs/providers/bedrock.md to focus on authentication methods instead of runtimeMode.\n\nCONTEXT: Documentation currently explains foundation vs application mode. Need to restructure around authentication methods.\n\nGOAL: Clear documentation of AWS SDK auth vs Bearer token auth.\n\nFILE: docs/providers/bedrock.md\n\nREMOVE all references to:\n- runtimeMode (lines 20, 45, 60, 65, 80, 140-148)\n- foundation mode vs application mode distinction\n\nRESTRUCTURE to:\n\n## Authentication Methods\n\nBedrock supports two authentication approaches:\n\n### AWS SDK Authentication (Recommended)\n\nUses IAM credentials with AWS SDK's ConverseCommand API.\nWorks with ALL model types: foundation models, cross-region inference profiles, application inference profiles.\n\n**Configuration options:**\n- AWS Profile: BEDROCK.profile=your-profile\n- Access Keys: BEDROCK.accessKeyId + BEDROCK.secretAccessKey\n- Environment variables: AWS_PROFILE, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY\n- IAM roles: Automatic on EC2/ECS/Lambda\n\n**Example config:**\n[BEDROCK]\nmodel=anthropic.claude-haiku-4-5-20251001-v1:0\nregion=us-east-1\nprofile=my-aws-profile\n\n### Bearer Token Authentication\n\nUses API key with HTTP Bearer token for application endpoints.\nFor use cases where AWS SDK auth cannot be used.\n\n**Configuration:**\n- API Key: BEDROCK.key or BEDROCK_API_KEY environment variable\n- Region or applicationBaseUrl required\n\n**Example config:**\n[BEDROCK]\nmodel=anthropic.claude-haiku-4-5-20251001-v1:0\nregion=us-east-1\nkey=your-api-key\n\n### Auto-Detection\n\nAuthentication method is automatically selected:\n- If AWS credentials configured → Uses AWS SDK (preferred)\n- If only API key configured → Uses Bearer token\n- If both configured → Uses AWS SDK (better integration)\n\n## Migration from runtimeMode\n\nIf your config has runtimeMode:\n- Remove it (field is deprecated and ignored)\n- Authentication method is now auto-detected from your credentials\n- No other changes needed","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:25.960305-06:00","updated_at":"2025-12-29T20:44:48.686671-06:00","closed_at":"2025-12-29T20:44:48.686673-06:00"}
{"id":"aicommit2-bf6","title":"Update validation to auth-based","description":"Update validateConfiguration() to validate authentication instead of runtimeMode.\n\nCONTEXT: Current validation (lines 115-143) checks if application mode has API key. This is wrong - we should validate that SOME auth method exists, not enforce mode-specific rules.\n\nGOAL: Replace mode-based validation with auth-based validation.\n\nFILE: src/services/ai/bedrock.service.ts\n\nREPLACE lines 115-143 with:\n\nprivate validateConfiguration(): void {\n    const config = this.bedrockConfig;\n\n    // Validate model ID is set\n    if (!isNonEmptyString(config.model)) {\n        const error: AIServiceError = new Error('Model ID or inference profile ARN is required.');\n        error.name = ERROR_NAMES.MISSING_MODEL_ID;\n        throw error;\n    }\n\n    // Validate region is set\n    if (!this.getRegion()) {\n        const error: AIServiceError = new Error(\n            'AWS region is required. Configure BEDROCK.region or set AWS_REGION/AWS_DEFAULT_REGION.'\n        );\n        error.name = ERROR_NAMES.MISSING_REGION;\n        throw error;\n    }\n\n    // Validate at least one auth method is configured\n    const hasApiKey = isNonEmptyString(config.key);\n    const hasAwsCredentials = this.canUseAwsSdk();\n\n    if (!hasApiKey \u0026\u0026 !hasAwsCredentials) {\n        const error: AIServiceError = new Error(\n            'Authentication required: Configure AWS credentials (profile, access keys, IAM role) or API key (BEDROCK.key).'\n        );\n        error.name = ERROR_NAMES.MISSING_API_KEY;\n        throw error;\n    }\n\n    // If using API key only, need endpoint configuration\n    if (hasApiKey \u0026\u0026 !hasAwsCredentials \u0026\u0026 !this.getRegion() \u0026\u0026 !isNonEmptyString(config.applicationBaseUrl)) {\n        const error: AIServiceError = new Error(\n            'Bearer token authentication requires region or applicationBaseUrl to construct endpoint.'\n        );\n        error.name = ERROR_NAMES.MISSING_REGION;\n        throw error;\n    }\n}\n\nALSO REMOVE:\n- Line 27: Delete 'type RuntimeMode = ...' type definition (no longer used)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:21.84861-06:00","updated_at":"2025-12-29T20:44:47.664232-06:00","closed_at":"2025-12-29T20:44:47.664235-06:00"}
{"id":"aicommit2-ddn","title":"Add auth detection methods","description":"Add authentication method detection to BedrockService.\n\nCONTEXT: Currently, BedrockService uses runtimeMode (foundation vs application) to decide which invocation method to use. This is wrong because runtimeMode conflates model type with auth method. AWS Bedrock supports:\n- All model types (foundation, cross-region profiles, application profiles) work with AWS SDK + IAM auth\n- API keys are an optional auth method (not tied to model type)\n\nGOAL: Add methods to detect which authentication method to use based on what credentials are configured.\n\nFILE: src/services/ai/bedrock.service.ts\n\nADD TWO NEW PRIVATE METHODS (after line 143):\n\n1. canUseAwsSdk(): boolean\n   - Check if AWS credentials are available\n   - Return true if: profile configured OR access keys configured OR AWS_PROFILE env var set OR AWS_ACCESS_KEY_ID env var set\n   - Logic:\n     const config = this.bedrockConfig;\n     const hasProfile = isNonEmptyString(config.profile) || isNonEmptyString(process.env.AWS_PROFILE);\n     const hasAccessKeys = \n         (isNonEmptyString(config.accessKeyId) \u0026\u0026 isNonEmptyString(config.secretAccessKey)) ||\n         (isNonEmptyString(process.env.AWS_ACCESS_KEY_ID) \u0026\u0026 isNonEmptyString(process.env.AWS_SECRET_ACCESS_KEY));\n     return hasProfile || hasAccessKeys;\n\n2. determineAuthMethod(): 'aws-sdk' | 'bearer-token'\n   - Determine which auth method to use\n   - Logic:\n     const hasApiKey = isNonEmptyString(this.bedrockConfig.key);\n     const hasAwsCredentials = this.canUseAwsSdk();\n     \n     // Prefer AWS SDK if available (recommended by AWS)\n     if (hasAwsCredentials) return 'aws-sdk';\n     if (hasApiKey) return 'bearer-token';\n     \n     throw new Error('No authentication method configured');\n\nNO OTHER CHANGES in this bead. Just add these two methods.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:19.539012-06:00","updated_at":"2025-12-29T20:44:47.047523-06:00","closed_at":"2025-12-29T20:44:47.047525-06:00"}
{"id":"aicommit2-mgl","title":"bedrock-auth-refactor","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T15:52:19.689761-06:00","updated_at":"2025-12-29T20:44:59.990384-06:00","closed_at":"2025-12-29T20:44:59.990386-06:00"}
{"id":"aicommit2-naq","title":"Simplify availability detection","description":"Simplify hasBedrockAccess() to use auth-based logic instead of mode-based.\n\nCONTEXT: get-available-ais.ts checks if Bedrock is available by validating runtimeMode requirements. Need to switch to auth-based validation.\n\nGOAL: Check for region + any auth method (API key OR AWS creds).\n\nFILE: src/commands/get-available-ais.ts\n\nREPLACE hasBedrockAccess function (lines 15-54) with:\n\nconst hasBedrockAccess = (value: RawConfig): boolean =\u003e {\n    const hasApiKey = isNonEmptyString(value.key as string);\n    const hasRegion =\n        isNonEmptyString(value.region as string) ||\n        isNonEmptyString(process.env.AWS_REGION) ||\n        isNonEmptyString(process.env.AWS_DEFAULT_REGION);\n    const hasProfile =\n        isNonEmptyString(value.profile as string) ||\n        isNonEmptyString(process.env.AWS_PROFILE);\n    const hasAccessKeys =\n        (isNonEmptyString(value.accessKeyId as string) \u0026\u0026 \n         isNonEmptyString(value.secretAccessKey as string)) ||\n        (isNonEmptyString(process.env.AWS_ACCESS_KEY_ID) \u0026\u0026 \n         isNonEmptyString(process.env.AWS_SECRET_ACCESS_KEY));\n\n    // Bedrock available if: region + at least one auth method\n    return hasRegion \u0026\u0026 (hasApiKey || hasProfile || hasAccessKeys);\n};\n\nREMOVE:\n- All runtimeMode detection logic\n- Separate hasFoundationAccess and hasApplicationAccess variables\n- All mode-specific checks","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:23.394114-06:00","updated_at":"2025-12-29T20:44:48.05867-06:00","closed_at":"2025-12-29T20:44:48.058672-06:00"}
{"id":"aicommit2-v76","title":"Remove runtimeMode from config","description":"Remove runtimeMode from config parser and add deprecation warning.\n\nCONTEXT: runtimeMode is being eliminated. Need to remove it from config parsing and warn users if it exists in their config.\n\nGOAL: Config parser ignores runtimeMode field (backward compatible).\n\nFILE: src/utils/config.ts\n\nCHANGES:\n\n1. Lines 698-723: REMOVE the entire runtimeMode parser function from modelConfigParsers.BEDROCK\n   \n2. REPLACE with simple deprecation handler:\n   runtimeMode: (runtimeMode?: string) =\u003e {\n       if (runtimeMode) {\n           console.warn(\n               '[Bedrock] DEPRECATION: runtimeMode is no longer used. Authentication method is now auto-detected from configured credentials.'\n           );\n       }\n       return undefined;\n   }\n\nThis keeps backward compatibility - old configs with runtimeMode still work, they just get a deprecation warning.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:22.620367-06:00","updated_at":"2025-12-29T20:44:47.867846-06:00","closed_at":"2025-12-29T20:44:47.867848-06:00"}
{"id":"aicommit2-yi7","title":"Update dispatch to auth-based","description":"Update generateMessage() to use auth-based dispatch instead of runtimeMode.\n\nCONTEXT: Currently line 247-251 use runtimeMode to decide which invocation method to call. Need to switch to authentication-based dispatch.\n\nGOAL: Use determineAuthMethod() instead of runtimeMode.\n\nFILE: src/services/ai/bedrock.service.ts\n\nCHANGES at lines 247-251:\n\nREMOVE:\n    const runtimeMode = config.runtimeMode as RuntimeMode;\n    const completion = \n        runtimeMode === 'application'\n            ? await this.invokeApplicationEndpoint({...})\n            : await this.invokeFoundationModel({...});\n\nREPLACE WITH:\n    const authMethod = this.determineAuthMethod();\n    const completion = \n        authMethod === 'bearer-token'\n            ? await this.invokeWithBearerToken({...})\n            : await this.invokeWithAwsSdk({...});\n\nNOTE: Use the renamed method names (invokeWithAwsSdk, invokeWithBearerToken) from previous bead.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:21.072699-06:00","updated_at":"2025-12-29T20:44:47.449557-06:00","closed_at":"2025-12-29T20:44:47.44956-06:00"}
{"id":"aicommit2-zob","title":"Update config integration tests","description":"Update tests/specs/config.ts integration tests for auth-based approach.\n\nCONTEXT: Integration tests (lines 251-577) test runtimeMode auto-detection and availability. Need to update for auth-based logic.\n\nGOAL: Test that Bedrock availability detection works with various auth configurations.\n\nFILE: tests/specs/config.ts\n\nUPDATE test scenarios (lines 251-577):\n\n1. Find tests checking 'runtimeMode' value - REMOVE these assertions\n2. Find tests using 'BEDROCK.runtimeMode=...' - REMOVE the runtimeMode setting\n3. Keep auth credential tests but remove mode expectations\n\nKey test updates:\n- 'IAM environment fallbacks' (lines 319-344): Remove runtimeMode check, keep AWS cred validation\n- 'Application API key fallback' (lines 346-379): Remove runtimeMode='application', just test API key works\n- 'Bedrock available with IAM' (lines 381-407): Remove runtimeMode assertion\n- 'Bedrock available with application endpoint details' (lines 408-434): Remove runtimeMode assertion  \n- 'Auto-detection of application mode' (lines 527-555): REMOVE (no auto-detection anymore)\n- 'Foundation mode default' (lines 556-577): REMOVE (no modes anymore)\n\nADD new test:\n- 'Bedrock available with either auth method'\n  Test that BEDROCK appears in availableAIs when:\n  a) Only profile configured\n  b) Only access keys configured  \n  c) Only API key configured\n  d) Both profile and API key configured","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T16:11:25.094572-06:00","updated_at":"2025-12-29T20:44:48.467903-06:00","closed_at":"2025-12-29T20:44:48.467905-06:00"}
